<?xml version="1.0" encoding="UTF-8"?>

<mule
	xmlns:tracking="http://www.mulesoft.org/schema/mule/ee/tracking"
	xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core"
	xmlns="http://www.mulesoft.org/schema/mule/core"
	xmlns:doc="http://www.mulesoft.org/schema/mule/documentation"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd
http://www.mulesoft.org/schema/mule/ee/tracking http://www.mulesoft.org/schema/mule/ee/tracking/current/mule-tracking-ee.xsd">
	<sub-flow name="log-error-details" doc:id="62a3f25f-6c6f-4ae4-b623-f4b963b79e4e" >
		<logger level="INFO" doc:name="Log the error details" doc:id="d92d627f-7649-47aa-b4c5-5b589ddace3a" message="#[payload]" />
	</sub-flow>
	<error-handler name="generic-global-error-handler-REST">
		<on-error-continue enableNotifications="true"
			logException="false" type="APIKIT:BAD_REQUEST">
			<ee:transform
				xsi:schemaLocation="http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd"
				doc:id="f3f953b1-69de-401b-a36e-c26c26979532"
				doc:name="Setting httpStatus">
				<ee:message>
				</ee:message>
				<ee:variables>
					<ee:set-variable variableName="httpStatus"><![CDATA[400]]></ee:set-variable>
				</ee:variables>
			</ee:transform>
			<flow-ref
				doc:name="Flow Reference to common-error-sub-flow-REST"
				doc:id="d8b843b5-836d-49b5-a200-f743051be7c2"
				name="common-error-sub-flow-REST" />

		</on-error-continue>
		<on-error-continue type="APIKIT:NOT_FOUND"
			enableNotifications="true" logException="false">
			<ee:transform
				xsi:schemaLocation="http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd"
				doc:id="9f26a7a9-6d18-4f5f-9240-f0e9d4edf0a8"
				doc:name="Setting httpStatus">
				<ee:message>
				</ee:message>
				<ee:variables>
					<ee:set-variable variableName="httpStatus"><![CDATA[404]]></ee:set-variable>
				</ee:variables>
			</ee:transform>
			<flow-ref
				doc:name="Flow Reference to common-error-sub-flow-REST"
				doc:id="d8b843b5-836d-49b5-a200-f743051be7c2"
				name="common-error-sub-flow-REST" />
		</on-error-continue>
		<on-error-continue
			type="APIKIT:METHOD_NOT_ALLOWED" enableNotifications="true"
			logException="false">
			<ee:transform
				xsi:schemaLocation="http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd"
				doc:id="2c4e329a-a75a-40fe-a104-0a112940a0ec"
				doc:name="Setting httpStatus">
				<ee:message>
				</ee:message>
				<ee:variables>
					<ee:set-variable variableName="httpStatus"><![CDATA[405]]></ee:set-variable>
				</ee:variables>
			</ee:transform>
			<flow-ref
				doc:name="Flow Reference to common-error-sub-flow-REST"
				doc:id="d8b843b5-836d-49b5-a200-f743051be7c2"
				name="common-error-sub-flow-REST" />
		</on-error-continue>
		<on-error-continue type="APIKIT:NOT_ACCEPTABLE"
			enableNotifications="true" logException="false">
			<ee:transform
				xsi:schemaLocation="http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd"
				doc:id="e9acf80c-6e90-4c25-9e4c-6e4f9f1d16c4"
				doc:name="Setting httpStatus">
				<ee:message>
				</ee:message>
				<ee:variables>
					<ee:set-variable variableName="httpStatus"><![CDATA[406]]></ee:set-variable>
				</ee:variables>
			</ee:transform>
			<flow-ref
				doc:name="Flow Reference to common-error-sub-flow-REST"
				doc:id="d8b843b5-836d-49b5-a200-f743051be7c2"
				name="common-error-sub-flow-REST" />
		</on-error-continue>
		<on-error-continue
			type="APIKIT:UNSUPPORTED_MEDIA_TYPE" enableNotifications="true"
			logException="false">
			<ee:transform
				xsi:schemaLocation="http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd"
				doc:id="ee3592e6-9fd3-4d44-8354-8b3afd46db4e"
				doc:name="Setting httpStatus">
				<ee:message>
				</ee:message>
				<ee:variables>
					<ee:set-variable variableName="httpStatus"><![CDATA[415]]></ee:set-variable>
				</ee:variables>
			</ee:transform>
			<flow-ref
				doc:name="Flow Reference to common-error-sub-flow-REST"
				doc:id="d8b843b5-836d-49b5-a200-f743051be7c2"
				name="common-error-sub-flow-REST" />
		</on-error-continue>
		<on-error-continue type="APIKIT:NOT_IMPLEMENTED"
			enableNotifications="true" logException="false">
			<ee:transform
				xsi:schemaLocation="http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd"
				doc:id="955cfd1e-ae03-492d-8fd5-a4436f3ccd1f"
				doc:name="Setting httpStatus">
				<ee:message>
				</ee:message>
				<ee:variables>
					<ee:set-variable variableName="httpStatus"><![CDATA[501]]></ee:set-variable>
				</ee:variables>
			</ee:transform>
			<flow-ref
				doc:name="Flow Reference to common-error-sub-flow-REST"
				doc:id="d8b843b5-836d-49b5-a200-f743051be7c2"
				name="common-error-sub-flow-REST" />
		</on-error-continue>
		<on-error-continue enableNotifications="true"
			logException="false" doc:name="On Error Continue"
			doc:id="e008c9dd-5627-4d57-9b3c-e8a78421c4a4"
			when='#[(error.errorType.identifier == "RETRY_EXHAUSTED")  or  (error.errorType.namespace == "HTTP")]'>
			<choice doc:name="Error Type Check"
				doc:id="fc7c9d32-a54e-41f7-a8db-40933eccf110">
				<when
					expression='#[error.errorType.identifier=="GATEWAY_TIMEOUT"]'>
					<ee:transform
						doc:name="Setting HTTP Status and Error Desc"
						doc:id="8dbc687b-d275-4d20-af6d-0c151e0a062a">
						<ee:message>
						</ee:message>
						<ee:variables>
							<ee:set-variable variableName="httpStatus"><![CDATA[500]]></ee:set-variable>
							<ee:set-variable variableName="errorDescription"><![CDATA[%dw 2.0
output application/java
---
responseDescription: "Downstream system is down"]]></ee:set-variable>
						</ee:variables>
					</ee:transform>
				</when>
				<otherwise>
					<ee:transform
						doc:name="Setting HTTP Status and Error Desc"
						doc:id="48a60919-a378-4839-b43c-15e685c4e44f">
						<ee:message>
						</ee:message>
						<ee:variables>
							<ee:set-variable variableName="httpStatus"><![CDATA[error.errorMessage.payload.statusCode default 500]]></ee:set-variable>
							<ee:set-variable variableName="errorDescription"><![CDATA[%dw 2.0
output application/java
---
error.errorMessage.payload]]></ee:set-variable>
						</ee:variables>
					</ee:transform>
				</otherwise>
			</choice>
			<flow-ref
				doc:name="Flow Reference to common-error-sub-flow-REST"
				doc:id="60189962-05d7-48d6-ab6c-9e5f11e4172f"
				name="common-error-sub-flow-REST" />
		</on-error-continue>
		<on-error-continue enableNotifications="true"
			logException="false" doc:name="On Error Continue"
			doc:id="62205cd4-a2ec-46eb-959f-6cac82b85b9a" type="ANY">
			<ee:transform doc:name="Setting Http Status"
				doc:id="bc67045d-3faa-47a4-ac32-1b79d5295094">
				<ee:message>
				</ee:message>
				<ee:variables>
					<ee:set-variable variableName="httpStatus"><![CDATA[%dw 2.0 
output application/json 
---
error.errorMessage.attributes.statusCode default 500
]]></ee:set-variable>
				</ee:variables>
			</ee:transform>
			<flow-ref
				doc:name="Flow Reference to common-error-sub-flow-REST"
				doc:id="d8b843b5-836d-49b5-a200-f743051be7c2"
				name="common-error-sub-flow-REST" />
		</on-error-continue>


	</error-handler>
	<sub-flow name="common-error-sub-flow-REST"
		doc:id="8a00e98d-c32f-495e-89d7-fcebdf54bbfb">
		<ee:transform doc:name="Error Payload"
			doc:id="15c7a2ef-dd9a-41b8-9251-7454d17b074b">
			<ee:message>
				<ee:set-payload><![CDATA[output application/json
var responseDescription=  if (vars.errorDescription.responseDescription?)  vars.errorDescription.responseDescription 
                          else  error.description default ""
---
{
"ERROR":
	{
	"APPLICATION-NAME": p('applicationName'),
	"ENVIRONMENT": p('mule.env'),
	"TIMESTAMP" : now(),
	"TRANSACTION-ID" : vars.correlationId,
	"REQUEST-PATH ": (vars.requestPath) default"",
	"MULE-FLOW-NAME ": (vars.flowName) default "",
	"ERROR-CODE" : (if(!isEmpty(vars.httpStatus)) vars.httpStatus else (flatten([message.error])..statusCode[0])) default 500,
	"ERROR-TYPE": error.errorType.identifier default "",
	"ERROR-MESSAGE": responseDescription,
	("REQUEST-PAYLOAD": vars.originalPayload) if ((vars.originalPayload) != null and !(isEmpty( vars.originalPayload))),
	 ("QUERY-PARAMS": vars.queryParams) if (vars.queryParams != null and vars.queryParams != {}),
	 ("URI-PARAMS": vars.uriParams) if (vars.uriParams != null and vars.uriParams != {}),
	}

}]]></ee:set-payload>
			</ee:message>
		</ee:transform>
		<flow-ref doc:name="Flow Reference to log-error-details" doc:id="f0916b4b-2cac-4cbd-90a6-caab0c63a849" name="log-error-details" />
	</sub-flow>


</mule>
